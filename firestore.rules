// ======================================================================
// File: firestore.rules
// ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô: 2025-10-11 (Task 11 Update)
// ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà: ‡πÄ‡∏û‡∏¥‡πà‡∏° Security Rules ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö checkIns ‡πÅ‡∏•‡∏∞ checkOuts collections
// ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ‡πÄ‡∏û‡∏¥‡πà‡∏° rules ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Daily Operations (Check-In/Check-Out)
// ======================================================================
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ===== users: ‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) =====
    match /users/{uid} {
      allow read: if request.auth != null && request.auth.uid == uid;
      allow write: if false;
    }

    // ===== admins: ‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) =====
    match /admins/{id} {
      allow read: if request.auth != null && (
        id == request.auth.uid ||
        (request.auth.token.email != null && id == request.auth.token.email)
      );
      allow write: if false;
    }

    // ===== requests: ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠ =====
    match /requests/{rid} {

      // ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÄ‡∏â‡∏û‡∏≤‡∏∞ "create" ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç
      allow create: if
        // ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ requestId ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏ï‡∏£‡∏¥‡∏á ‡πÅ‡∏•‡∏∞‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏ß‡πâ‡∏≤‡∏á ‡πÜ (‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£/‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç/._- ‡∏¢‡∏≤‡∏ß 6‚Äì64)
        request.resource.data.requestId is string &&
        request.resource.data.requestId.matches('^[A-Za-z0-9._-]{6,64}$') &&

        // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô "pending"
        request.resource.data.status == "pending" &&

        // requester ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà (map) ‡πÅ‡∏•‡∏∞‡∏°‡∏µ name/phone ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏ï‡∏£‡∏¥‡∏á
        request.resource.data.requester is map &&
        request.resource.data.requester.name is string &&
        request.resource.data.requester.phone is string &&

        // (‡∏≠‡∏≠‡∏õ‡∏ä‡∏±‡∏ô) createdAt ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡πá‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô timestamp
        (
          !('createdAt' in request.resource.data) ||
          request.resource.data.createdAt is timestamp
        );

      // ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏•‡∏ö ‡∏à‡∏≤‡∏Å client
      allow read, update, delete: if false;
    }

    // ===== subcollections ‡πÉ‡∏ï‡πâ‡∏Ñ‡∏≥‡∏Ç‡∏≠ (‡πÄ‡∏õ‡∏¥‡∏î create ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏ß‡πá‡∏ö‡∏™‡∏∞‡∏î‡∏∏‡∏î) =====
    // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏ä‡πà‡∏ô: /requests/{rid}/uploads/{doc}, /requests/{rid}/workers/{doc}
    match /requests/{rid}/{anySub=**} {
      allow create: if true; // ‡∏à‡∏∞‡∏Ñ‡πà‡∏≠‡∏¢ ‡πÜ ‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡πÉ‡∏ô‡∏Ç‡∏±‡πâ‡∏ô A-2
      allow read, update, delete: if false;
    }

    // ===== üÜï checkIns: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô (Task 11) =====
    match /checkIns/{checkInId} {
      // ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå viewTodayWork ‡∏´‡∏£‡∏∑‡∏≠ viewOtherDaysWork
      allow read: if request.auth != null && 
        exists(/databases/$(database)/documents/admins/$(request.auth.token.email)) &&
        (
          get(/databases/$(database)/documents/admins/$(request.auth.token.email)).data.permissions.viewTodayWork == true ||
          get(/databases/$(database)/documents/admins/$(request.auth.token.email)).data.permissions.viewOtherDaysWork == true
        );
      
      // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡πà‡∏≤‡∏ô Cloud Functions (client ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô)
      allow write: if false;
    }

    // ===== üÜï checkOuts: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå (Task 11) =====
    match /checkOuts/{checkOutId} {
      // ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå viewTodayWork ‡∏´‡∏£‡∏∑‡∏≠ viewOtherDaysWork
      allow read: if request.auth != null && 
        exists(/databases/$(database)/documents/admins/$(request.auth.token.email)) &&
        (
          get(/databases/$(database)/documents/admins/$(request.auth.token.email)).data.permissions.viewTodayWork == true ||
          get(/databases/$(database)/documents/admins/$(request.auth.token.email)).data.permissions.viewOtherDaysWork == true
        );
      
      // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡πà‡∏≤‡∏ô Cloud Functions (client ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô)
      allow write: if false;
    }

    // ===== ‡∏õ‡∏¥‡∏î‡∏ó‡∏∏‡∏Å path ‡∏≠‡∏∑‡πà‡∏ô =====
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
