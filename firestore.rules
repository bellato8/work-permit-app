// ======================================================================
// File: firestore.rules
// ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô: 2025-10-14 (Task 6 - Granular Permissions)
// ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏≠‡πà‡∏≤‡∏ô/‡πÅ‡∏Å‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î, ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á,
//          ‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏õ‡∏ó‡∏µ‡πà pagePermissions.dailyWork.*
// ======================================================================

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ====================================================================
    // Helper Functions (‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ ‡πÉ‡∏ä‡πâ‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ)
    // ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ get()/exists() ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏à‡∏≤‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏≠‡∏∑‡πà‡∏ô‡∏ï‡∏≤‡∏°‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£
    // ====================================================================
    function isAuthenticated() {
      return request.auth != null && request.auth.token.email != null;
    }

    function isSelf(email) {
      // ‡∏™‡∏°‡∏°‡∏∏‡∏ï‡∏¥‡∏ß‡πà‡∏≤ document id ‡πÉ‡∏ô /admins ‡πÉ‡∏ä‡πâ email ‡∏à‡∏£‡∏¥‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö token
      return isAuthenticated() && email == request.auth.token.email;
    }

    function currentAdminExists() {
      return isAuthenticated() &&
             exists(/databases/$(database)/documents/admins/$(request.auth.token.email));
    }

    function currentAdminRole() {
      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠ currentAdminExists() ‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏£‡∏¥‡∏á
      return get(/databases/$(database)/documents/admins/$(request.auth.token.email)).data.role;
    }

    function isAdminOrAbove() {
      return currentAdminExists() &&
             (currentAdminRole() == 'admin' || currentAdminRole() == 'superadmin');
    }

    function isSuperAdmin() {
      return currentAdminExists() && currentAdminRole() == 'superadmin';
    }

    // ====================================================================
    // users: ‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°)
    // ====================================================================
    match /users/{uid} {
      allow read: if request.auth != null && request.auth.uid == uid;
      allow write: if false;
    }

    // ====================================================================
    // admins: (‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÉ‡∏´‡∏°‡πà)
    // - ‡∏≠‡πà‡∏≤‡∏ô: ‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÄ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠ ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô/‡∏ã‡∏π‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
    // - ‡∏™‡∏£‡πâ‡∏≤‡∏á: ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô/‡∏ã‡∏π‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
    // - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô/‡∏ã‡∏π‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô + ‡∏´‡πâ‡∏≤‡∏°‡πÅ‡∏Å‡πâ role ‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
    //          + ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤‡∏´‡πâ‡∏≤‡∏°‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏Ñ‡∏£‡πÄ‡∏õ‡πá‡∏ô superadmin
    // - ‡∏•‡∏ö: ‡∏ã‡∏π‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÅ‡∏•‡∏∞‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
    // ====================================================================
    match /admins/{email} {

      // READ
      allow read: if isSelf(email) || isAdminOrAbove();

      // CREATE
      allow create: if isAdminOrAbove();

      // UPDATE
      allow update: if isAdminOrAbove()
        && (
          // 1) ‡πÅ‡∏Å‡πâ‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô
          !isSelf(email)
          // 2) ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏Å‡πâ‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á ‡πÅ‡∏ï‡πà "role" ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô
          || (isSelf(email) && request.resource.data.role == resource.data.role)
        )
        // 3) ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤ ‡∏´‡πâ‡∏≤‡∏°‡∏ï‡∏±‡πâ‡∏á role ‡πÄ‡∏õ‡πá‡∏ô superadmin
        && (isSuperAdmin() || request.resource.data.role != 'superadmin');

      // DELETE
      allow delete: if isSuperAdmin() && !isSelf(email);

      // subcollections (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‚Äî ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
      match /{document=**} {
        allow read, write: if isAdminOrAbove();
      }
    }

    // ====================================================================
    // requests: ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠ (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°)
    // ====================================================================
    match /requests/{rid} {
      allow create: if
        request.resource.data.requestId is string &&
        request.resource.data.requestId.matches('^[A-Za-z0-9._-]{6,64}$') &&

        request.resource.data.status == "pending" &&

        request.resource.data.requester is map &&
        request.resource.data.requester.name is string &&
        request.resource.data.requester.phone is string &&

        (
          !('createdAt' in request.resource.data) ||
          request.resource.data.createdAt is timestamp
        );

      allow read, update, delete: if false;
    }

    // subcollections ‡πÉ‡∏ï‡πâ‡∏Ñ‡∏≥‡∏Ç‡∏≠ (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤)
    match /requests/{rid}/{anySub=**} {
      allow create: if true; // ‡∏à‡∏∞‡∏Ñ‡πà‡∏≠‡∏¢ ‡πÜ ‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡πÉ‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ
      allow read, update, delete: if false;
    }

    // ====================================================================
    // üÜï checkIns / checkOuts: ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡πá‡∏Å‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏à‡∏≤‡∏Å pagePermissions.dailyWork
    //    - ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ñ‡πâ‡∏≤‡∏ú‡∏π‡πâ‡∏£‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏î‡∏π‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô (canView)
    //      ‡∏´‡∏£‡∏∑‡∏≠‡∏î‡∏π‡∏ß‡∏±‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÑ‡∏î‡πâ (canViewOtherDays)
    // ====================================================================
    match /checkIns/{checkInId} {
      allow read: if isAuthenticated()
        && currentAdminExists()
        && (
          get(/databases/$(database)/documents/admins/$(request.auth.token.email)).data.pagePermissions.dailyWork.canView == true
          || get(/databases/$(database)/documents/admins/$(request.auth.token.email)).data.pagePermissions.dailyWork.canViewOtherDays == true
        );
      allow write: if false; // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ú‡πà‡∏≤‡∏ô Cloud Functions ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
    }

    match /checkOuts/{checkOutId} {
      allow read: if isAuthenticated()
        && currentAdminExists()
        && (
          get(/databases/$(database)/documents/admins/$(request.auth.token.email)).data.pagePermissions.dailyWork.canView == true
          || get(/databases/$(database)/documents/admins/$(request.auth.token.email)).data.pagePermissions.dailyWork.canViewOtherDays == true
        );
      allow write: if false; // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ú‡πà‡∏≤‡∏ô Cloud Functions ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
    }

    // ====================================================================
    // ‡∏õ‡∏¥‡∏î‡∏ó‡∏∏‡∏Å path ‡∏≠‡∏∑‡πà‡∏ô
    // ====================================================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
