// ======================================================================
// File: firestore.rules
// ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô: 2025-10-26 (Add internal_requests self-scope + locations read)
// ‡∏≠‡∏¥‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 2025-10-14 (Task 6 - Granular Permissions)
// ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°:
//   - ‡∏≠‡πà‡∏≤‡∏ô "‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà": artifacts/{appId}/public/data/locations ‡πÅ‡∏•‡∏∞ /locations (‡∏™‡∏≥‡∏£‡∏≠‡∏á)
//   - ‡πÉ‡∏´‡πâ‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á uid ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ internal_requests ‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ
// ======================================================================

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ====================================================================
    // Helper Functions (‡πÄ‡∏î‡∏¥‡∏°) + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö uid
    // ====================================================================
    function isAuthenticated() {
      return request.auth != null && request.auth.token.email != null;
    }

    function isSelf(email) {
      // ‡∏™‡∏°‡∏°‡∏∏‡∏ï‡∏¥‡∏ß‡πà‡∏≤ document id ‡πÉ‡∏ô /admins ‡πÉ‡∏ä‡πâ email ‡∏à‡∏£‡∏¥‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö token
      return isAuthenticated() && email == request.auth.token.email;
    }

    function isSelfUid(uid) {
      return request.auth != null && request.auth.uid == uid;
    }

    function currentAdminExists() {
      return isAuthenticated() &&
             exists(/databases/$(database)/documents/admins/$(request.auth.token.email));
    }

    function currentAdminRole() {
      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠ currentAdminExists() ‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏£‡∏¥‡∏á
      return get(/databases/$(database)/documents/admins/$(request.auth.token.email)).data.role;
    }

    function isAdminOrAbove() {
      return currentAdminExists() &&
             (currentAdminRole() == 'admin' || currentAdminRole() == 'superadmin');
    }

    function isSuperAdmin() {
      return currentAdminExists() && currentAdminRole() == 'superadmin';
    }

    // ====================================================================
    // users: ‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°)
    // ====================================================================
    match /users/{uid} {
      allow read: if request.auth != null && request.auth.uid == uid;
      allow write: if false;
    }

    // ====================================================================
    // admins: (‡∏Ñ‡∏á‡∏ï‡∏≤‡∏°‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°)
    // ====================================================================
    match /admins/{email} {

      // READ
      allow read: if isSelf(email) || isAdminOrAbove();

      // CREATE
      allow create: if isAdminOrAbove();

      // UPDATE
      allow update: if isAdminOrAbove()
        && (
          // 1) ‡πÅ‡∏Å‡πâ‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô
          !isSelf(email)
          // 2) ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏Å‡πâ‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á ‡πÅ‡∏ï‡πà "role" ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô
          || (isSelf(email) && request.resource.data.role == resource.data.role)
        )
        // 3) ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤ ‡∏´‡πâ‡∏≤‡∏°‡∏ï‡∏±‡πâ‡∏á role ‡πÄ‡∏õ‡πá‡∏ô superadmin
        && (isSuperAdmin() || request.resource.data.role != 'superadmin');

      // DELETE
      allow delete: if isSuperAdmin() && !isSelf(email);

      // subcollections (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
      match /{document=**} {
        allow read, write: if isAdminOrAbove();
      }
    }

    // ====================================================================
    // requests: ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠ (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°)
    // ====================================================================
    match /requests/{rid} {
      allow create: if
        request.resource.data.requestId is string &&
        request.resource.data.requestId.matches('^[A-Za-z0-9._-]{6,64}$') &&

        request.resource.data.status == "pending" &&

        request.resource.data.requester is map &&
        request.resource.data.requester.name is string &&
        request.resource.data.requester.phone is string &&

        (
          !('createdAt' in request.resource.data) ||
          request.resource.data.createdAt is timestamp
        );

      allow read, update, delete: if false;
    }

    // subcollections ‡πÉ‡∏ï‡πâ‡∏Ñ‡∏≥‡∏Ç‡∏≠ (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤)
    match /requests/{rid}/{anySub=**} {
      allow create: if true; // ‡∏à‡∏∞‡∏Ñ‡πà‡∏≠‡∏¢ ‡πÜ ‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡πÉ‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ
      allow read, update, delete: if false;
    }

    // ====================================================================
    // üÜï checkIns / checkOuts: ‡∏≠‡∏¥‡∏á pagePermissions.dailyWork.* (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°)
    // ====================================================================
    match /checkIns/{checkInId} {
      allow read: if isAuthenticated()
        && currentAdminExists()
        && (
          get(/databases/$(database)/documents/admins/$(request.auth.token.email)).data.pagePermissions.dailyWork.canView == true
          || get(/databases/$(database)/documents/admins/$(request.auth.token.email)).data.pagePermissions.dailyWork.canViewOtherDays == true
        );
      allow write: if false; // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ú‡πà‡∏≤‡∏ô Cloud Functions ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
    }

    match /checkOuts/{checkOutId} {
      allow read: if isAuthenticated()
        && currentAdminExists()
        && (
          get(/databases/$(database)/documents/admins/$(request.auth.token.email)).data.pagePermissions.dailyWork.canView == true
          || get(/databases/$(database)/documents/admins/$(request.auth.token.email)).data.pagePermissions.dailyWork.canViewOtherDays == true
        );
      allow write: if false; // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ú‡πà‡∏≤‡∏ô Cloud Functions ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
    }

    // ====================================================================
    // üÜï ‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡πà‡∏≤‡∏ô "‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà" ‡πÉ‡∏´‡πâ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏î‡∏∂‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ
    //    - ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏´‡∏•‡∏±‡∏Å: artifacts/{appId}/public/data/locations/{locId}
    //    - ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏™‡∏≥‡∏£‡∏≠‡∏á: /locations/{locId} (‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÉ‡∏ä‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô)
    // ====================================================================
    match /artifacts/{appId}/public/data/locations/{locId} {
      allow read: if true;   // ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏ä‡∏ß‡πå‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà/‡∏ä‡∏±‡πâ‡∏ô
      allow write: if false; // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ñ‡πà‡∏≠‡∏¢‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤ LP/Admin ‡∏î‡∏π‡πÅ‡∏•‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏ï‡πà‡∏≠‡πÑ‡∏õ
    }

    match /locations/{locId} {
      allow read: if true;   // ‡∏™‡∏≥‡∏£‡∏≠‡∏á ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ß‡πà‡∏≤‡∏á‡∏ï‡∏≠‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö
      allow write: if false;
    }

    // ====================================================================
    // üÜï ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ:
    //    artifacts/{appId}/users/{userId}/internal_requests/{reqId}
    //    ‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á uid ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ (‡∏™‡∏£‡πâ‡∏≤‡∏á/‡∏≠‡πà‡∏≤‡∏ô/‡πÅ‡∏Å‡πâ/‡∏•‡∏ö)
    // ====================================================================
    match /artifacts/{appId}/users/{userId}/internal_requests/{reqId} {
      allow create: if isSelfUid(userId);
      allow read:   if isSelfUid(userId);
      allow update: if isSelfUid(userId);
      allow delete: if isSelfUid(userId);
    }

    // ====================================================================
    // üÜï Department Admin: ‡πÄ‡∏û‡∏¥‡πà‡∏° 30/10/2025
    //    ‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡πÅ‡∏ú‡∏ô‡∏Å - ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ô‡πÉ‡∏ô‡πÅ‡∏ú‡∏ô‡∏Å‡πÅ‡∏•‡∏∞‡∏î‡∏π‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏ú‡∏ô‡∏Å
    // ====================================================================

    // Department Admins collection
    match /dept_admins/{deptAdminId} {
      // Helper: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô dept admin ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
      function isDeptAdmin() {
        return isAuthenticated() &&
               exists(/databases/$(database)/documents/dept_admins/$(request.auth.token.email));
      }

      function isSelfDeptAdmin(deptAdminId) {
        return isAuthenticated() &&
               (request.auth.token.email == deptAdminId || request.auth.uid == deptAdminId);
      }

      // READ: ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô superadmin
      allow read: if isSelfDeptAdmin(deptAdminId) || isSuperAdmin();

      // CREATE: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏î‡πâ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô superadmin
      allow create: if isSuperAdmin();

      // UPDATE: ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô superadmin
      allow update: if isSuperAdmin();

      // DELETE: ‡∏•‡∏ö‡πÑ‡∏î‡πâ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô superadmin ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
      allow delete: if isSuperAdmin() && !isSelfDeptAdmin(deptAdminId);
    }

    // Department Members collection
    match /dept_members/{memberId} {
      // Helper: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô dept admin ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
      function isDeptAdminOfMember() {
        return isAuthenticated() &&
               exists(/databases/$(database)/documents/dept_admins/$(request.auth.token.email)) &&
               get(/databases/$(database)/documents/dept_admins/$(request.auth.token.email)).data.enabled == true &&
               get(/databases/$(database)/documents/dept_admins/$(request.auth.token.email)).data.department == resource.data.department;
      }

      function canCreateMember() {
        return isAuthenticated() &&
               exists(/databases/$(database)/documents/dept_admins/$(request.auth.token.email)) &&
               get(/databases/$(database)/documents/dept_admins/$(request.auth.token.email)).data.enabled == true &&
               get(/databases/$(database)/documents/dept_admins/$(request.auth.token.email)).data.department == request.resource.data.department;
      }

      // READ: ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô dept admin ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ superadmin
      allow read: if isDeptAdminOfMember() || isSuperAdmin();

      // CREATE: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏î‡πâ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô dept admin ‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ô‡πÅ‡∏ú‡∏ô‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
      allow create: if canCreateMember() || isSuperAdmin();

      // UPDATE: ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô dept admin ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
      allow update: if isDeptAdminOfMember() || isSuperAdmin();

      // DELETE: ‡∏•‡∏ö‡πÑ‡∏î‡πâ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô dept admin ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
      allow delete: if isDeptAdminOfMember() || isSuperAdmin();
    }

    // ====================================================================
    // ‡∏õ‡∏¥‡∏î‡∏ó‡∏∏‡∏Å path ‡∏≠‡∏∑‡πà‡∏ô (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°)
    // ====================================================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
