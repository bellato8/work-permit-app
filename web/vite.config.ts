// ======================================================================
// File: web/vite.config.ts
// เวอร์ชัน: 2025-10-02 (Asia/Bangkok)
// แนวคิด: รองรับเบราว์เซอร์เก่าพอสมควร โดยไม่ทำให้ของใหม่ช้าเกินไป
//  - โหลดปลั๊กอิน "เครื่องเก่า" เฉพาะตอน build โปรดักชัน
//  - ตั้งกลุ่มเครื่องเป้าหมายแบบสมดุล (ยังครอบคลุม Chrome/Firefox เก่าระดับองค์กร)
//  - ตั้ง cssTarget เป็น 'chrome61' กันอาการสี/เอฟเฟกต์บางอย่างเพี้ยนในรุ่นเก่า
// ======================================================================

import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'
import legacy from '@vitejs/plugin-legacy'

export default defineConfig(({ mode }) => {
  const isProd = mode === 'production'

  return {
    plugins: [
      react(),

      // โหลด "ของรองรับเครื่องเก่า" เฉพาะตอนโปรดักชัน (ตอน dev ให้ไวและเบา)
      ...(isProd
        ? [legacy({
            // กลุ่มเครื่องเป้าหมาย: สมดุล (เก่าพอประมาณ แต่ไม่ลากไปไกลจนไฟล์บวมมาก)
            targets: [
              'defaults',
              'not dead',
              'Chrome >= 61',
              'Firefox >= 68',
              'Safari >= 12',
              'iOS >= 12',
            ],

            // ให้ตัวช่วยเติมฟีเจอร์ที่เครื่องขาด “แบบอัตโนมัติ”
            modernPolyfills: true,

            // เติมตัวช่วยสำหรับคำสั่งพวก async/await ให้เครื่องที่เก่ามากเข้าใจ
            additionalLegacyPolyfills: ['regenerator-runtime/runtime'],
          })]
        : []),
    ],

    build: {
      // ให้ไฟล์หลักยังคงทันสมัยพอควร (ทันสมัยสำหรับของใหม่, แต่ไม่ได้ย้อนยุคเกินไป)
      target: 'es2017',

      // ปรับระดับ CSS ให้เข้ากับเครื่องรุ่นเก่าที่พบในองค์กร (กันสี/เอฟเฟกต์แปลกๆ บางเคส)
      cssTarget: 'chrome61',

      // ตอน dev มีแผนที่โค้ดไว้สืบปัญหาง่าย / โปรดักชันปิดไว้ให้ไฟล์เล็ก
      sourcemap: !isProd,
    },
  }
})
